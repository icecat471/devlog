<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Go언어에서의 DDD | icecat471&#39;s Devlog</title>
<meta name="keywords" content="go, golang, DDD, Domain-Driven Design" />
<meta name="description" content="Reference https://dev.to/stevensunflash/using-domain-driven-design-ddd-in-golang-3ee5 https://github.com/victorsteven/food-app-server
DDD(Domain Driven Design) DDD의 4Layers   Domain : domain이 위치하고, 애플리케이션의 비즈니스로직이 정의된 곳
  Infrastructure : 애플리케이션과 독립적인 모든 것이 존재하는 곳(외부 라이브러리, 데이터베이스 엔진 등)
  Application : domain과 interface 사이의 통로. interface layer에서 domain layer로 요청을 보내고 응답을 반환
  Interface : 웹 서비스, RIM 인터페이스 웹 애플리케이션, 배치 프로세스 등 다른 시스템과 상호작용 하는 모든 것이 위치
  시작 이 프로젝트는 구조는 아래와 같다.">
<meta name="author" content="icecat471">
<link rel="canonical" href="https://icecat471.github.io/devlog/post/server/ddd_in_go/" />
<link crossorigin="anonymous" href="/devlog/assets/css/stylesheet.min.5ddba2377cef4826c901d6600bb403811fc5084e4de37bd1a967782b2b74485f.css" integrity="sha256-XduiN3zvSCbJAdZgC7QDgR/FCE5N43vRqWd4Kyt0SF8=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/devlog/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://icecat471.github.io/devlog/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://icecat471.github.io/devlog/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://icecat471.github.io/devlog/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://icecat471.github.io/devlog/apple-touch-icon.png">
<link rel="mask-icon" href="https://icecat471.github.io/devlog/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.88.1" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Go언어에서의 DDD" />
<meta property="og:description" content="Reference https://dev.to/stevensunflash/using-domain-driven-design-ddd-in-golang-3ee5 https://github.com/victorsteven/food-app-server
DDD(Domain Driven Design) DDD의 4Layers   Domain : domain이 위치하고, 애플리케이션의 비즈니스로직이 정의된 곳
  Infrastructure : 애플리케이션과 독립적인 모든 것이 존재하는 곳(외부 라이브러리, 데이터베이스 엔진 등)
  Application : domain과 interface 사이의 통로. interface layer에서 domain layer로 요청을 보내고 응답을 반환
  Interface : 웹 서비스, RIM 인터페이스 웹 애플리케이션, 배치 프로세스 등 다른 시스템과 상호작용 하는 모든 것이 위치
  시작 이 프로젝트는 구조는 아래와 같다." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://icecat471.github.io/devlog/post/server/ddd_in_go/" /><meta property="og:image" content="https://icecat471.github.io/devlog/papermod-cover.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-28T11:09:17&#43;09:00" />
<meta property="article:modified_time" content="2021-10-28T11:09:17&#43;09:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://icecat471.github.io/devlog/papermod-cover.png"/>

<meta name="twitter:title" content="Go언어에서의 DDD"/>
<meta name="twitter:description" content="Reference https://dev.to/stevensunflash/using-domain-driven-design-ddd-in-golang-3ee5 https://github.com/victorsteven/food-app-server
DDD(Domain Driven Design) DDD의 4Layers   Domain : domain이 위치하고, 애플리케이션의 비즈니스로직이 정의된 곳
  Infrastructure : 애플리케이션과 독립적인 모든 것이 존재하는 곳(외부 라이브러리, 데이터베이스 엔진 등)
  Application : domain과 interface 사이의 통로. interface layer에서 domain layer로 요청을 보내고 응답을 반환
  Interface : 웹 서비스, RIM 인터페이스 웹 애플리케이션, 배치 프로세스 등 다른 시스템과 상호작용 하는 모든 것이 위치
  시작 이 프로젝트는 구조는 아래와 같다."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://icecat471.github.io/devlog/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Go언어에서의 DDD",
      "item": "https://icecat471.github.io/devlog/post/server/ddd_in_go/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go언어에서의 DDD",
  "name": "Go언어에서의 DDD",
  "description": "Reference https://dev.to/stevensunflash/using-domain-driven-design-ddd-in-golang-3ee5 https://github.com/victorsteven/food-app-server\nDDD(Domain Driven Design) DDD의 4Layers   Domain : domain이 위치하고, 애플리케이션의 비즈니스로직이 정의된 곳\n  Infrastructure : 애플리케이션과 독립적인 모든 것이 존재하는 곳(외부 라이브러리, 데이터베이스 엔진 등)\n  Application : domain과 interface 사이의 통로. interface layer에서 domain layer로 요청을 보내고 응답을 반환\n  Interface : 웹 서비스, RIM 인터페이스 웹 애플리케이션, 배치 프로세스 등 다른 시스템과 상호작용 하는 모든 것이 위치\n  시작 이 프로젝트는 구조는 아래와 같다.",
  "keywords": [
    "go", "golang", "DDD", "Domain-Driven Design"
  ],
  "articleBody": "Reference https://dev.to/stevensunflash/using-domain-driven-design-ddd-in-golang-3ee5 https://github.com/victorsteven/food-app-server\nDDD(Domain Driven Design) DDD의 4Layers   Domain : domain이 위치하고, 애플리케이션의 비즈니스로직이 정의된 곳\n  Infrastructure : 애플리케이션과 독립적인 모든 것이 존재하는 곳(외부 라이브러리, 데이터베이스 엔진 등)\n  Application : domain과 interface 사이의 통로. interface layer에서 domain layer로 요청을 보내고 응답을 반환\n  Interface : 웹 서비스, RIM 인터페이스 웹 애플리케이션, 배치 프로세스 등 다른 시스템과 상호작용 하는 모든 것이 위치\n  시작 이 프로젝트는 구조는 아래와 같다.\n이 애플리케이션에서는, postgres와 redis를 DB로 사용할 것이다.\nroot 폴더에 아래와 같은 .env 파일이 필요하다.\n#Postgres APP_ENV=local API_PORT=8888 DB_HOST=127.0.0.1 DB_DRIVER=postgres ACCESS_SECRET=98hbun98h REFRESH_SECRET=786dfdbjhsb DB_USER=steven DB_PASSWORD=password DB_NAME=food-app DB_PORT=5432 #Postgres Test DB TEST_DB_DRIVER=postgres TEST_DB_HOST=127.0.0.1 TEST_DB_PASSWORD=password TEST_DB_USER=steven TEST_DB_NAME=food-app-test TEST_DB_PORT=5432 #Redis REDIS_HOST=127.0.0.1 REDIS_PORT=6379 REDIS_PASSWORD= Domain Layer domain을 먼저 생각해보자. 도메인은 몇 가지 패턴을 갖고 있다.\nEntity, Value, Repository, Service 등등.\n간단하게 2가지 도메인 패턴만을 생각해보자(entity, repository)\nEntity 스키마 같은 것을 정의하는 곳.\n예를 들어, 여기에는 user structure를 정의하였다.\npackage entity import ( \"food-app/infrastructure/security\" \"github.com/badoux/checkmail\" \"html\" \"strings\" \"time\" ) type User struct { ID uint64 `gorm:\"primary_key;auto_increment\" json:\"id\"` FirstName string `gorm:\"size:100;not null;\" json:\"first_name\"` LastName string `gorm:\"size:100;not null;\" json:\"last_name\"` Email string `gorm:\"size:100;not null;unique\" json:\"email\"` Password string `gorm:\"size:100;not null;\" json:\"password\"` CreatedAt time.Time `gorm:\"default:CURRENT_TIMESTAMP\" json:\"created_at\"` UpdatedAt time.Time `gorm:\"default:CURRENT_TIMESTAMP\" json:\"updated_at\"` DeletedAt *time.Time `json:\"deleted_at,omitempty\"` } type PublicUser struct { ID uint64 `gorm:\"primary_key;auto_increment\" json:\"id\"` FirstName string `gorm:\"size:100;not null;\" json:\"first_name\"` LastName string `gorm:\"size:100;not null;\" json:\"last_name\"` } //BeforeSave is a gorm hook func (u *User) BeforeSave() error { hashPassword, err := security.Hash(u.Password) if err != nil { return err } u.Password = string(hashPassword) return nil } type Users []User //So that we dont expose the user's email address and password to the world func (users Users) PublicUsers() []interface{} { result := make([]interface{}, len(users)) for index, user := range users { result[index] = user.PublicUser() } return result } //So that we dont expose the user's email address and password to the world func (u *User) PublicUser() interface{} { return \u0026PublicUser{ ID: u.ID, FirstName: u.FirstName, LastName: u.LastName, } } func (u *User) Prepare() { u.FirstName = html.EscapeString(strings.TrimSpace(u.FirstName)) u.LastName = html.EscapeString(strings.TrimSpace(u.LastName)) u.Email = html.EscapeString(strings.TrimSpace(u.Email)) u.CreatedAt = time.Now() u.UpdatedAt = time.Now() } func (u *User) Validate(action string) map[string]string { var errorMessages = make(map[string]string) var err error switch strings.ToLower(action) { case \"update\": if u.Email == \"\" { errorMessages[\"email_required\"] = \"email required\" } if u.Email != \"\" { if err = checkmail.ValidateFormat(u.Email); err != nil { errorMessages[\"invalid_email\"] = \"email email\" } } case \"login\": if u.Password == \"\" { errorMessages[\"password_required\"] = \"password is required\" } if u.Email == \"\" { errorMessages[\"email_required\"] = \"email is required\" } if u.Email != \"\" { if err = checkmail.ValidateFormat(u.Email); err != nil { errorMessages[\"invalid_email\"] = \"please provide a valid email\" } } case \"forgotpassword\": if u.Email == \"\" { errorMessages[\"email_required\"] = \"email required\" } if u.Email != \"\" { if err = checkmail.ValidateFormat(u.Email); err != nil { errorMessages[\"invalid_email\"] = \"please provide a valid email\" } } default: if u.FirstName == \"\" { errorMessages[\"firstname_required\"] = \"first name is required\" } if u.LastName == \"\" { errorMessages[\"lastname_required\"] = \"last name is required\" } if u.Password == \"\" { errorMessages[\"password_required\"] = \"password is required\" } if u.Password != \"\" \u0026\u0026 len(u.Password)  6 { errorMessages[\"invalid_password\"] = \"password should be at least 6 characters\" } if u.Email == \"\" { errorMessages[\"email_required\"] = \"email is required\" } if u.Email != \"\" { if err = checkmail.ValidateFormat(u.Email); err != nil { errorMessages[\"invalid_email\"] = \"please provide a valid email\" } } } return errorMessages } Repository repository는 infrastructure에서 구현할 method의 집합을 정의한다.\npackage repository import ( \"food-app/domain/entity\" ) type UserRepository interface { SaveUser(*entity.User) (*entity.User, map[string]string) GetUser(uint64) (*entity.User, error) GetUsers() ([]entity.User, error) GetUserByEmailAndPassword(*entity.User) (*entity.User, map[string]string) } Infrastructure Layer repository에 정의된 method를 구현.\nmethod는 database 또는 third-party API와 상호작용한다.\n여기에서는 database와의 작용만을 생각해 볼 것이다.\npackage persistence import ( \"errors\" \"food-app/domain/entity\" \"food-app/domain/repository\" \"food-app/infrastructure/security\" \"github.com/jinzhu/gorm\" \"golang.org/x/crypto/bcrypt\" \"strings\" ) type UserRepo struct { db *gorm.DB } func NewUserRepository(db *gorm.DB) *UserRepo { return \u0026UserRepo{db} } //UserRepo implements the repository.UserRepository interface var _ repository.UserRepository = \u0026UserRepo{} func (r *UserRepo) SaveUser(user *entity.User) (*entity.User, map[string]string) { dbErr := map[string]string{} err := r.db.Debug().Create(\u0026user).Error if err != nil { //If the email is already taken \tif strings.Contains(err.Error(), \"duplicate\") || strings.Contains(err.Error(), \"Duplicate\") { dbErr[\"email_taken\"] = \"email already taken\" return nil, dbErr } //any other db error \tdbErr[\"db_error\"] = \"database error\" return nil, dbErr } return user, nil } func (r *UserRepo) GetUser(id uint64) (*entity.User, error) { var user entity.User err := r.db.Debug().Where(\"id = ?\", id).Take(\u0026user).Error if err != nil { return nil, err } if gorm.IsRecordNotFoundError(err) { return nil, errors.New(\"user not found\") } return \u0026user, nil } func (r *UserRepo) GetUsers() ([]entity.User, error) { var users []entity.User err := r.db.Debug().Find(\u0026users).Error if err != nil { return nil, err } if gorm.IsRecordNotFoundError(err) { return nil, errors.New(\"user not found\") } return users, nil } func (r *UserRepo) GetUserByEmailAndPassword(u *entity.User) (*entity.User, map[string]string) { var user entity.User dbErr := map[string]string{} err := r.db.Debug().Where(\"email = ?\", u.Email).Take(\u0026user).Error if gorm.IsRecordNotFoundError(err) { dbErr[\"no_user\"] = \"user not found\" return nil, dbErr } if err != nil { dbErr[\"db_error\"] = \"database error\" return nil, dbErr } //Verify the password \terr = security.VerifyPassword(user.Password, u.Password) if err != nil \u0026\u0026 err == bcrypt.ErrMismatchedHashAndPassword { dbErr[\"incorrect_password\"] = \"incorrect password\" return nil, dbErr } return \u0026user, nil } db.go 파일도 살펴보자\npackage persistence import ( \"fmt\" \"food-app/domain/entity\" \"food-app/domain/repository\" \"github.com/jinzhu/gorm\" _ \"github.com/jinzhu/gorm/dialects/postgres\" ) type Repositories struct { User repository.UserRepository Food repository.FoodRepository db *gorm.DB } func NewRepositories(Dbdriver, DbUser, DbPassword, DbPort, DbHost, DbName string) (*Repositories, error) { DBURL := fmt.Sprintf(\"host=%s port=%s user=%s dbname=%s sslmode=disable password=%s\", DbHost, DbPort, DbUser, DbName, DbPassword) db, err := gorm.Open(Dbdriver, DBURL) if err != nil { return nil, err } db.LogMode(true) return \u0026Repositories{ User: NewUserRepository(db), Food: NewFoodRepository(db), db: db, }, nil } //closes the database connection func (s *Repositories) Close() error { return s.db.Close() } //This migrate all tables func (s *Repositories) Automigrate() error { return s.db.AutoMigrate(\u0026entity.User{}, \u0026entity.Food{}).Error } 위 파일에서 모든 repository를 갖고 있는 Repositories structure를 정의하였다.\n또한 Repositories는 db instance를 갖고 있어서 user와 food repository의 생성자로 주입된다.\nApplication Layer application은 domain과 interface에 연결한다.\nuser application을 살펴보자\npackage application import ( \"food-app/domain/entity\" \"food-app/domain/repository\" ) type userApp struct { us repository.UserRepository } //UserApp implements the UserAppInterface var _ UserAppInterface = \u0026userApp{} type UserAppInterface interface { SaveUser(*entity.User) (*entity.User, map[string]string) GetUsers() ([]entity.User, error) GetUser(uint64) (*entity.User, error) GetUserByEmailAndPassword(*entity.User) (*entity.User, map[string]string) } func (u *userApp) SaveUser(user *entity.User) (*entity.User, map[string]string) { return u.us.SaveUser(user) } func (u *userApp) GetUser(userId uint64) (*entity.User, error) { return u.us.GetUser(userId) } func (u *userApp) GetUsers() ([]entity.User, error) { return u.us.GetUsers() } func (u *userApp) GetUserByEmailAndPassword(user *entity.User) (*entity.User, map[string]string) { return u.us.GetUserByEmailAndPassword(user) } UserApp은 UserRepository를 갖고있어 repository의 method를 호출할 수 있게 해준다.\nInterface Layer interface는 HTTP request와 response를 담당한다.\n여기서 인증, 유저관련, 음식관련 request를 받아들인다.\nUser Handler save, get 등의 user 관련 method가 정의되어 있음.\npackage interfaces import ( \"food-app/application\" \"food-app/domain/entity\" \"food-app/infrastructure/auth\" \"github.com/gin-gonic/gin\" \"net/http\" \"strconv\" ) //Users struct defines the dependencies that will be used type Users struct { us application.UserAppInterface rd auth.AuthInterface tk auth.TokenInterface } //Users constructor func NewUsers(us application.UserAppInterface, rd auth.AuthInterface, tk auth.TokenInterface) *Users { return \u0026Users{ us: us, rd: rd, tk: tk, } } func (s *Users) SaveUser(c *gin.Context) { var user entity.User if err := c.ShouldBindJSON(\u0026user); err != nil { c.JSON(http.StatusUnprocessableEntity, gin.H{ \"invalid_json\": \"invalid json\", }) return } //validate the request: \tvalidateErr := user.Validate(\"\") if len(validateErr)  0 { c.JSON(http.StatusUnprocessableEntity, validateErr) return } newUser, err := s.us.SaveUser(\u0026user) if err != nil { c.JSON(http.StatusInternalServerError, err) return } c.JSON(http.StatusCreated, newUser.PublicUser()) } func (s *Users) GetUsers(c *gin.Context) { users := entity.Users{} //customize user \tvar err error //us, err = application.UserApp.GetUsers() \tusers, err = s.us.GetUsers() if err != nil { c.JSON(http.StatusInternalServerError, err.Error()) return } c.JSON(http.StatusOK, users.PublicUsers()) } func (s *Users) GetUser(c *gin.Context) { userId, err := strconv.ParseUint(c.Param(\"user_id\"), 10, 64) if err != nil { c.JSON(http.StatusBadRequest, err.Error()) return } user, err := s.us.GetUser(userId) if err != nil { c.JSON(http.StatusInternalServerError, err.Error()) return } c.JSON(http.StatusOK, user.PublicUser()) } Authentication Handler login_handler 는 로그인, 로그아웃, 리프레시 토큰 등의 method를 담당.\npackage interfaces import ( \"fmt\" \"food-app/application\" \"food-app/domain/entity\" \"food-app/infrastructure/auth\" \"github.com/dgrijalva/jwt-go\" \"github.com/gin-gonic/gin\" \"net/http\" \"os\" \"strconv\" ) type Authenticate struct { us application.UserAppInterface rd auth.AuthInterface tk auth.TokenInterface } //Authenticate constructor func NewAuthenticate(uApp application.UserAppInterface, rd auth.AuthInterface, tk auth.TokenInterface) *Authenticate { return \u0026Authenticate{ us: uApp, rd: rd, tk: tk, } } func (au *Authenticate) Login(c *gin.Context) { var user *entity.User var tokenErr = map[string]string{} if err := c.ShouldBindJSON(\u0026user); err != nil { c.JSON(http.StatusUnprocessableEntity, \"Invalid json provided\") return } //validate request: \tvalidateUser := user.Validate(\"login\") if len(validateUser)  0 { c.JSON(http.StatusUnprocessableEntity, validateUser) return } u, userErr := au.us.GetUserByEmailAndPassword(user) if userErr != nil { c.JSON(http.StatusInternalServerError, userErr) return } ts, tErr := au.tk.CreateToken(u.ID) if tErr != nil { tokenErr[\"token_error\"] = tErr.Error() c.JSON(http.StatusUnprocessableEntity, tErr.Error()) return } saveErr := au.rd.CreateAuth(u.ID, ts) if saveErr != nil { c.JSON(http.StatusInternalServerError, saveErr.Error()) return } userData := make(map[string]interface{}) userData[\"access_token\"] = ts.AccessToken userData[\"refresh_token\"] = ts.RefreshToken userData[\"id\"] = u.ID userData[\"first_name\"] = u.FirstName userData[\"last_name\"] = u.LastName c.JSON(http.StatusOK, userData) } func (au *Authenticate) Logout(c *gin.Context) { //check is the user is authenticated first \tmetadata, err := au.tk.ExtractTokenMetadata(c.Request) if err != nil { c.JSON(http.StatusUnauthorized, \"Unauthorized\") return } //if the access token exist and it is still valid, then delete both the access token and the refresh token \tdeleteErr := au.rd.DeleteTokens(metadata) if deleteErr != nil { c.JSON(http.StatusUnauthorized, deleteErr.Error()) return } c.JSON(http.StatusOK, \"Successfully logged out\") } //Refresh is the function that uses the refresh_token to generate new pairs of refresh and access tokens. func (au *Authenticate) Refresh(c *gin.Context) { mapToken := map[string]string{} if err := c.ShouldBindJSON(\u0026mapToken); err != nil { c.JSON(http.StatusUnprocessableEntity, err.Error()) return } refreshToken := mapToken[\"refresh_token\"] //verify the token \ttoken, err := jwt.Parse(refreshToken, func(token *jwt.Token) (interface{}, error) { //Make sure that the token method conform to \"SigningMethodHMAC\" \tif _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok { return nil, fmt.Errorf(\"unexpected signing method: %v\", token.Header[\"alg\"]) } return []byte(os.Getenv(\"REFRESH_SECRET\")), nil }) //any error may be due to token expiration \tif err != nil { c.JSON(http.StatusUnauthorized, err.Error()) return } //is token valid? \tif _, ok := token.Claims.(jwt.Claims); !ok \u0026\u0026 !token.Valid { c.JSON(http.StatusUnauthorized, err) return } //Since token is valid, get the uuid: \tclaims, ok := token.Claims.(jwt.MapClaims) if ok \u0026\u0026 token.Valid { refreshUuid, ok := claims[\"refresh_uuid\"].(string) //convert the interface to string \tif !ok { c.JSON(http.StatusUnprocessableEntity, \"Cannot get uuid\") return } userId, err := strconv.ParseUint(fmt.Sprintf(\"%.f\", claims[\"user_id\"]), 10, 64) if err != nil { c.JSON(http.StatusUnprocessableEntity, \"Error occurred\") return } //Delete the previous Refresh Token \tdelErr := au.rd.DeleteRefresh(refreshUuid) if delErr != nil { //if any goes wrong \tc.JSON(http.StatusUnauthorized, \"unauthorized\") return } //Create new pairs of refresh and access tokens \tts, createErr := au.tk.CreateToken(userId) if createErr != nil { c.JSON(http.StatusForbidden, createErr.Error()) return } //save the tokens metadata to redis \tsaveErr := au.rd.CreateAuth(userId, ts) if saveErr != nil { c.JSON(http.StatusForbidden, saveErr.Error()) return } tokens := map[string]string{ \"access_token\": ts.AccessToken, \"refresh_token\": ts.RefreshToken, } c.JSON(http.StatusCreated, tokens) } else { c.JSON(http.StatusUnauthorized, \"refresh token expired\") } } Running the Application main.go 에서는 route 정의, db에 연결, 애플리케이션 시작 등의 기능을 하고 있다.\npackage main import ( \"food-app/infrastructure/auth\" \"food-app/infrastructure/persistence\" \"food-app/interfaces\" \"food-app/interfaces/fileupload\" \"food-app/interfaces/middleware\" \"github.com/gin-gonic/gin\" \"github.com/joho/godotenv\" \"log\" \"os\" ) func init() { //To load our environmental variables. \tif err := godotenv.Load(); err != nil { log.Println(\"no env gotten\") } } func main() { dbdriver := os.Getenv(\"DB_DRIVER\") host := os.Getenv(\"DB_HOST\") password := os.Getenv(\"DB_PASSWORD\") user := os.Getenv(\"DB_USER\") dbname := os.Getenv(\"DB_NAME\") port := os.Getenv(\"DB_PORT\") //redis details \tredis_host := os.Getenv(\"REDIS_HOST\") redis_port := os.Getenv(\"REDIS_PORT\") redis_password := os.Getenv(\"REDIS_PASSWORD\") services, err := persistence.NewRepositories(dbdriver, user, password, port, host, dbname) if err != nil { panic(err) } defer services.Close() services.Automigrate() redisService, err := auth.NewRedisDB(redis_host, redis_port, redis_password) if err != nil { log.Fatal(err) } tk := auth.NewToken() fd := fileupload.NewFileUpload() users := interfaces.NewUsers(services.User, redisService.Auth, tk) foods := interfaces.NewFood(services.Food, services.User, fd, redisService.Auth, tk) authenticate := interfaces.NewAuthenticate(services.User, redisService.Auth, tk) r := gin.Default() r.Use(middleware.CORSMiddleware()) //For CORS  //user routes \tr.POST(\"/users\", users.SaveUser) r.GET(\"/users\", users.GetUsers) r.GET(\"/users/:user_id\", users.GetUser) //post routes \tr.POST(\"/food\", middleware.AuthMiddleware(), middleware.MaxSizeAllowed(8192000), foods.SaveFood) r.PUT(\"/food/:food_id\", middleware.AuthMiddleware(), middleware.MaxSizeAllowed(8192000), foods.UpdateFood) r.GET(\"/food/:food_id\", foods.GetFoodAndCreator) r.DELETE(\"/food/:food_id\", middleware.AuthMiddleware(), foods.DeleteFood) r.GET(\"/food\", foods.GetAllFood) //authentication routes \tr.POST(\"/login\", authenticate.Login) r.POST(\"/logout\", authenticate.Logout) r.POST(\"/refresh\", authenticate.Refresh) //Starting the application \tapp_port := os.Getenv(\"PORT\") //using heroku host \tif app_port == \"\" { app_port = \"8888\" //localhost \t} log.Fatal(r.Run(\":\"+app_port)) } Middleware 위 main.go 파일에서 특정 route는 제한되어 있다. AuthMiddleware는 인증되지 않은 유저의 접근을 제한할 것이다.\nCORSMiddleware는 다른 domain으로의 data 전송을 허용해준다. MaxSizeAllowed는 미들웨어에서 제한된 사이즈 이상의 파일의 업로드를 막아준다.\npackage middleware import ( \"bytes\" \"food-app/infrastructure/auth\" \"github.com/gin-gonic/gin\" \"io/ioutil\" \"net/http\" ) func AuthMiddleware() gin.HandlerFunc { return func(c *gin.Context) { err := auth.TokenValid(c.Request) if err != nil { c.JSON(http.StatusUnauthorized, gin.H{ \"status\": http.StatusUnauthorized, \"error\": err.Error(), }) c.Abort() return } c.Next() } } func CORSMiddleware() gin.HandlerFunc { return func(c *gin.Context) { c.Writer.Header().Set(\"Access-Control-Allow-Origin\", \"*\") c.Writer.Header().Set(\"Access-Control-Allow-Credentials\", \"true\") c.Writer.Header().Set(\"Access-Control-Allow-Headers\", \"Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token, Authorization, accept, origin, Cache-Control, X-Requested-With\") c.Writer.Header().Set(\"Access-Control-Allow-Methods\", \"POST, OPTIONS, GET, PUT, PATCH, DELETE\") if c.Request.Method == \"OPTIONS\" { c.AbortWithStatus(204) return } c.Next() } } //Avoid a large file from loading into memory //If the file size is greater than 8MB dont allow it to even load into memory and waste our time. func MaxSizeAllowed(n int64) gin.HandlerFunc { return func(c *gin.Context) { c.Request.Body = http.MaxBytesReader(c.Writer, c.Request.Body, n) buff, errRead := c.GetRawData() if errRead != nil { //c.JSON(http.StatusRequestEntityTooLarge,\"too large\") \tc.JSON(http.StatusRequestEntityTooLarge, gin.H{ \"status\": http.StatusRequestEntityTooLarge, \"upload_err\": \"too large: upload an image less than 8MB\", }) c.Abort() return } buf := bytes.NewBuffer(buff) c.Request.Body = ioutil.NopCloser(buf) } } ",
  "wordCount" : "2114",
  "inLanguage": "en",
  "datePublished": "2021-10-28T11:09:17+09:00",
  "dateModified": "2021-10-28T11:09:17+09:00",
  "author":{
    "@type": "Person",
    "name": "icecat471"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://icecat471.github.io/devlog/post/server/ddd_in_go/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "icecat471's Devlog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://icecat471.github.io/devlog/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://icecat471.github.io/devlog/" accesskey="h" title="icecat471&#39;s Devlog (Alt + H)">icecat471&#39;s Devlog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://icecat471.github.io/devlog/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://icecat471.github.io/devlog/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://icecat471.github.io/devlog/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://icecat471.github.io/devlog/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://icecat471.github.io/devlog/">Home</a>&nbsp;»&nbsp;<a href="https://icecat471.github.io/devlog/post/">Posts</a></div>
    <h1 class="post-title">
      Go언어에서의 DDD
    </h1>
    <div class="post-meta">October 28, 2021&nbsp;·&nbsp;10 min&nbsp;·&nbsp;icecat471

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#reference" aria-label="Reference">Reference</a></li>
                <li>
                    <a href="#ddddomain-driven-design" aria-label="DDD(Domain Driven Design)">DDD(Domain Driven Design)</a><ul>
                        
                <li>
                    <a href="#ddd%ec%9d%98-4layers" aria-label="DDD의 4Layers">DDD의 4Layers</a></li></ul>
                </li>
                <li>
                    <a href="#%ec%8b%9c%ec%9e%91" aria-label="시작">시작</a><ul>
                        
                <li>
                    <a href="#domain-layer" aria-label="Domain Layer">Domain Layer</a><ul>
                        
                <li>
                    <a href="#entity" aria-label="Entity">Entity</a></li>
                <li>
                    <a href="#repository" aria-label="Repository">Repository</a></li></ul>
                </li>
                <li>
                    <a href="#infrastructure-layer" aria-label="Infrastructure Layer">Infrastructure Layer</a></li>
                <li>
                    <a href="#application-layer" aria-label="Application Layer">Application Layer</a></li>
                <li>
                    <a href="#interface-layer" aria-label="Interface Layer">Interface Layer</a><ul>
                        
                <li>
                    <a href="#user-handler" aria-label="User Handler">User Handler</a></li>
                <li>
                    <a href="#authentication-handler" aria-label="Authentication Handler">Authentication Handler</a></li></ul>
                </li>
                <li>
                    <a href="#running-the-application" aria-label="Running the Application">Running the Application</a></li>
                <li>
                    <a href="#middleware" aria-label="Middleware">Middleware</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">#</a></h1>
<p><a href="https://dev.to/stevensunflash/using-domain-driven-design-ddd-in-golang-3ee5">https://dev.to/stevensunflash/using-domain-driven-design-ddd-in-golang-3ee5</a>
<a href="https://github.com/victorsteven/food-app-server">https://github.com/victorsteven/food-app-server</a></p>
<h1 id="ddddomain-driven-design">DDD(Domain Driven Design)<a hidden class="anchor" aria-hidden="true" href="#ddddomain-driven-design">#</a></h1>
<h2 id="ddd의-4layers">DDD의 4Layers<a hidden class="anchor" aria-hidden="true" href="#ddd의-4layers">#</a></h2>
<p><img loading="lazy" src="../../../img/server/4layers_in_ddd.jpg" alt="4layers in ddd"  />
</p>
<ol>
<li>
<p>Domain : domain이 위치하고, 애플리케이션의 비즈니스로직이 정의된 곳</p>
</li>
<li>
<p>Infrastructure : 애플리케이션과 독립적인 모든 것이 존재하는 곳(외부 라이브러리, 데이터베이스 엔진 등)</p>
</li>
<li>
<p>Application : domain과 interface 사이의 통로. interface layer에서 domain layer로 요청을 보내고 응답을 반환</p>
</li>
<li>
<p>Interface : 웹 서비스, RIM 인터페이스 웹 애플리케이션, 배치 프로세스 등 다른 시스템과 상호작용 하는 모든 것이 위치</p>
</li>
</ol>
<h1 id="시작">시작<a hidden class="anchor" aria-hidden="true" href="#시작">#</a></h1>
<p>이 프로젝트는 구조는 아래와 같다.</p>
<p><img loading="lazy" src="../../../img/server/food_app_structure.png" alt="food-app structure"  />
</p>
<p>이 애플리케이션에서는, postgres와 redis를 DB로 사용할 것이다.<br>
root 폴더에 아래와 같은 .env 파일이 필요하다.</p>
<pre tabindex="0"><code>#Postgres
APP_ENV=local
API_PORT=8888
DB_HOST=127.0.0.1                
DB_DRIVER=postgres
ACCESS_SECRET=98hbun98h
REFRESH_SECRET=786dfdbjhsb
DB_USER=steven
DB_PASSWORD=password
DB_NAME=food-app
DB_PORT=5432

#Postgres Test DB
TEST_DB_DRIVER=postgres
TEST_DB_HOST=127.0.0.1
TEST_DB_PASSWORD=password
TEST_DB_USER=steven
TEST_DB_NAME=food-app-test
TEST_DB_PORT=5432

#Redis
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=
</code></pre><h2 id="domain-layer">Domain Layer<a hidden class="anchor" aria-hidden="true" href="#domain-layer">#</a></h2>
<p>domain을 먼저 생각해보자. 도메인은 몇 가지 패턴을 갖고 있다.<br>
Entity, Value, Repository, Service 등등.</p>
<p><img loading="lazy" src="../../../img/server/food_app_domain_layer.png" alt="food_app_domain_layer.png"  />
</p>
<p>간단하게 2가지 도메인 패턴만을 생각해보자(entity, repository)</p>
<h3 id="entity">Entity<a hidden class="anchor" aria-hidden="true" href="#entity">#</a></h3>
<p>스키마 같은 것을 정의하는 곳.<br>
예를 들어, 여기에는 user structure를 정의하였다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">entity</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;food-app/infrastructure/security&#34;</span>
	<span class="s">&#34;github.com/badoux/checkmail&#34;</span>
	<span class="s">&#34;html&#34;</span>
	<span class="s">&#34;strings&#34;</span>
	<span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">ID</span>        <span class="kt">uint64</span>     <span class="s">`gorm:&#34;primary_key;auto_increment&#34; json:&#34;id&#34;`</span>
	<span class="nx">FirstName</span> <span class="kt">string</span>     <span class="s">`gorm:&#34;size:100;not null;&#34; json:&#34;first_name&#34;`</span>
	<span class="nx">LastName</span>  <span class="kt">string</span>     <span class="s">`gorm:&#34;size:100;not null;&#34; json:&#34;last_name&#34;`</span>
	<span class="nx">Email</span>     <span class="kt">string</span>     <span class="s">`gorm:&#34;size:100;not null;unique&#34; json:&#34;email&#34;`</span>
	<span class="nx">Password</span>  <span class="kt">string</span>     <span class="s">`gorm:&#34;size:100;not null;&#34; json:&#34;password&#34;`</span>
	<span class="nx">CreatedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>  <span class="s">`gorm:&#34;default:CURRENT_TIMESTAMP&#34; json:&#34;created_at&#34;`</span>
	<span class="nx">UpdatedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>  <span class="s">`gorm:&#34;default:CURRENT_TIMESTAMP&#34; json:&#34;updated_at&#34;`</span>
	<span class="nx">DeletedAt</span> <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&#34;deleted_at,omitempty&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">PublicUser</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">ID</span>        <span class="kt">uint64</span> <span class="s">`gorm:&#34;primary_key;auto_increment&#34; json:&#34;id&#34;`</span>
	<span class="nx">FirstName</span> <span class="kt">string</span> <span class="s">`gorm:&#34;size:100;not null;&#34; json:&#34;first_name&#34;`</span>
	<span class="nx">LastName</span>  <span class="kt">string</span> <span class="s">`gorm:&#34;size:100;not null;&#34; json:&#34;last_name&#34;`</span>
<span class="p">}</span>

<span class="c1">//BeforeSave is a gorm hook
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">User</span><span class="p">)</span> <span class="nf">BeforeSave</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">hashPassword</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">security</span><span class="p">.</span><span class="nf">Hash</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Password</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">u</span><span class="p">.</span><span class="nx">Password</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">hashPassword</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Users</span> <span class="p">[]</span><span class="nx">User</span>

<span class="c1">//So that we dont expose the user&#39;s email address and password to the world
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">users</span> <span class="nx">Users</span><span class="p">)</span> <span class="nf">PublicUsers</span><span class="p">()</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
	<span class="nx">result</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kd">interface</span><span class="p">{},</span> <span class="nb">len</span><span class="p">(</span><span class="nx">users</span><span class="p">))</span>
	<span class="k">for</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">user</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">users</span> <span class="p">{</span>
		<span class="nx">result</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="p">=</span> <span class="nx">user</span><span class="p">.</span><span class="nf">PublicUser</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>

<span class="c1">//So that we dont expose the user&#39;s email address and password to the world
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">User</span><span class="p">)</span> <span class="nf">PublicUser</span><span class="p">()</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">PublicUser</span><span class="p">{</span>
		<span class="nx">ID</span><span class="p">:</span>        <span class="nx">u</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
		<span class="nx">FirstName</span><span class="p">:</span> <span class="nx">u</span><span class="p">.</span><span class="nx">FirstName</span><span class="p">,</span>
		<span class="nx">LastName</span><span class="p">:</span>  <span class="nx">u</span><span class="p">.</span><span class="nx">LastName</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">User</span><span class="p">)</span> <span class="nf">Prepare</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">u</span><span class="p">.</span><span class="nx">FirstName</span> <span class="p">=</span> <span class="nx">html</span><span class="p">.</span><span class="nf">EscapeString</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">FirstName</span><span class="p">))</span>
	<span class="nx">u</span><span class="p">.</span><span class="nx">LastName</span> <span class="p">=</span> <span class="nx">html</span><span class="p">.</span><span class="nf">EscapeString</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">LastName</span><span class="p">))</span>
	<span class="nx">u</span><span class="p">.</span><span class="nx">Email</span> <span class="p">=</span> <span class="nx">html</span><span class="p">.</span><span class="nf">EscapeString</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Email</span><span class="p">))</span>
	<span class="nx">u</span><span class="p">.</span><span class="nx">CreatedAt</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
	<span class="nx">u</span><span class="p">.</span><span class="nx">UpdatedAt</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">User</span><span class="p">)</span> <span class="nf">Validate</span><span class="p">(</span><span class="nx">action</span> <span class="kt">string</span><span class="p">)</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">errorMessages</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>

	<span class="k">switch</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="s">&#34;update&#34;</span><span class="p">:</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;email_required&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;email required&#34;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">checkmail</span><span class="p">.</span><span class="nf">ValidateFormat</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Email</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;invalid_email&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;email email&#34;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="s">&#34;login&#34;</span><span class="p">:</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Password</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;password_required&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;password is required&#34;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;email_required&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;email is required&#34;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">checkmail</span><span class="p">.</span><span class="nf">ValidateFormat</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Email</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;invalid_email&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;please provide a valid email&#34;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="s">&#34;forgotpassword&#34;</span><span class="p">:</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;email_required&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;email required&#34;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">checkmail</span><span class="p">.</span><span class="nf">ValidateFormat</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Email</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;invalid_email&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;please provide a valid email&#34;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">FirstName</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;firstname_required&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;first name is required&#34;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">LastName</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;lastname_required&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;last name is required&#34;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Password</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;password_required&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;password is required&#34;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Password</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Password</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">6</span> <span class="p">{</span>
			<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;invalid_password&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;password should be at least 6 characters&#34;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;email_required&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;email is required&#34;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">checkmail</span><span class="p">.</span><span class="nf">ValidateFormat</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Email</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">errorMessages</span><span class="p">[</span><span class="s">&#34;invalid_email&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;please provide a valid email&#34;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">errorMessages</span>
<span class="p">}</span>
</code></pre></div><h3 id="repository">Repository<a hidden class="anchor" aria-hidden="true" href="#repository">#</a></h3>
<p>repository는 infrastructure에서 구현할 method의 집합을 정의한다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">repository</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;food-app/domain/entity&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">UserRepository</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">SaveUser</span><span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
	<span class="nf">GetUser</span><span class="p">(</span><span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">GetUsers</span><span class="p">()</span> <span class="p">([]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">GetUserByEmailAndPassword</span><span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h2 id="infrastructure-layer">Infrastructure Layer<a hidden class="anchor" aria-hidden="true" href="#infrastructure-layer">#</a></h2>
<p>repository에 정의된 method를 구현.<br>
method는 database 또는 third-party API와 상호작용한다.<br>
여기에서는 database와의 작용만을 생각해 볼 것이다.</p>
<p><img loading="lazy" src="../../../img/server/food_app_infrastructure_layer.png" alt="food_app_infrastructure_layer.png"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">persistence</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;errors&#34;</span>
	<span class="s">&#34;food-app/domain/entity&#34;</span>
	<span class="s">&#34;food-app/domain/repository&#34;</span>
	<span class="s">&#34;food-app/infrastructure/security&#34;</span>
	<span class="s">&#34;github.com/jinzhu/gorm&#34;</span>
	<span class="s">&#34;golang.org/x/crypto/bcrypt&#34;</span>
	<span class="s">&#34;strings&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">UserRepo</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewUserRepository</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="o">*</span><span class="nx">UserRepo</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">UserRepo</span><span class="p">{</span><span class="nx">db</span><span class="p">}</span>
<span class="p">}</span>
<span class="c1">//UserRepo implements the repository.UserRepository interface
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">_</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">UserRepository</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">UserRepo</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">UserRepo</span><span class="p">)</span> <span class="nf">SaveUser</span><span class="p">(</span><span class="nx">user</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">dbErr</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Debug</span><span class="p">().</span><span class="nf">Create</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">).</span><span class="nx">Error</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">//If the email is already taken
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="s">&#34;duplicate&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="s">&#34;Duplicate&#34;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">dbErr</span><span class="p">[</span><span class="s">&#34;email_taken&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;email already taken&#34;</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">dbErr</span>
		<span class="p">}</span>
		<span class="c1">//any other db error
</span><span class="c1"></span>		<span class="nx">dbErr</span><span class="p">[</span><span class="s">&#34;db_error&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;database error&#34;</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">dbErr</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">user</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">UserRepo</span><span class="p">)</span> <span class="nf">GetUser</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">user</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">User</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Debug</span><span class="p">().</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;id = ?&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">).</span><span class="nf">Take</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">).</span><span class="nx">Error</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">IsRecordNotFoundError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;user not found&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">user</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">UserRepo</span><span class="p">)</span> <span class="nf">GetUsers</span><span class="p">()</span> <span class="p">([]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">users</span> <span class="p">[]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Debug</span><span class="p">().</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">users</span><span class="p">).</span><span class="nx">Error</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">IsRecordNotFoundError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;user not found&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">users</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">UserRepo</span><span class="p">)</span> <span class="nf">GetUserByEmailAndPassword</span><span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">user</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">User</span>
	<span class="nx">dbErr</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Debug</span><span class="p">().</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;email = ?&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span><span class="p">).</span><span class="nf">Take</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">).</span><span class="nx">Error</span>
	<span class="k">if</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">IsRecordNotFoundError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">dbErr</span><span class="p">[</span><span class="s">&#34;no_user&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;user not found&#34;</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">dbErr</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">dbErr</span><span class="p">[</span><span class="s">&#34;db_error&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;database error&#34;</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">dbErr</span>
	<span class="p">}</span>
	<span class="c1">//Verify the password
</span><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">security</span><span class="p">.</span><span class="nf">VerifyPassword</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Password</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">ErrMismatchedHashAndPassword</span> <span class="p">{</span>
		<span class="nx">dbErr</span><span class="p">[</span><span class="s">&#34;incorrect_password&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;incorrect password&#34;</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">dbErr</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">user</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>db.go 파일도 살펴보자</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">persistence</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;food-app/domain/entity&#34;</span>
	<span class="s">&#34;food-app/domain/repository&#34;</span>
	<span class="s">&#34;github.com/jinzhu/gorm&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/jinzhu/gorm/dialects/postgres&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Repositories</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">User</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">UserRepository</span>
	<span class="nx">Food</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">FoodRepository</span>
	<span class="nx">db</span>   <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewRepositories</span><span class="p">(</span><span class="nx">Dbdriver</span><span class="p">,</span> <span class="nx">DbUser</span><span class="p">,</span> <span class="nx">DbPassword</span><span class="p">,</span> <span class="nx">DbPort</span><span class="p">,</span> <span class="nx">DbHost</span><span class="p">,</span> <span class="nx">DbName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Repositories</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">DBURL</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;host=%s port=%s user=%s dbname=%s sslmode=disable password=%s&#34;</span><span class="p">,</span> <span class="nx">DbHost</span><span class="p">,</span> <span class="nx">DbPort</span><span class="p">,</span> <span class="nx">DbUser</span><span class="p">,</span> <span class="nx">DbName</span><span class="p">,</span> <span class="nx">DbPassword</span><span class="p">)</span>
	<span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">Dbdriver</span><span class="p">,</span> <span class="nx">DBURL</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">db</span><span class="p">.</span><span class="nf">LogMode</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Repositories</span><span class="p">{</span>
		<span class="nx">User</span><span class="p">:</span> <span class="nf">NewUserRepository</span><span class="p">(</span><span class="nx">db</span><span class="p">),</span>
		<span class="nx">Food</span><span class="p">:</span> <span class="nf">NewFoodRepository</span><span class="p">(</span><span class="nx">db</span><span class="p">),</span>
		<span class="nx">db</span><span class="p">:</span>   <span class="nx">db</span><span class="p">,</span>
	<span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">//closes the  database connection
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Repositories</span><span class="p">)</span> <span class="nf">Close</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">//This migrate all tables
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Repositories</span><span class="p">)</span> <span class="nf">Automigrate</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">AutoMigrate</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">{},</span> <span class="o">&amp;</span><span class="nx">entity</span><span class="p">.</span><span class="nx">Food</span><span class="p">{}).</span><span class="nx">Error</span>
<span class="p">}</span>
</code></pre></div><p>위 파일에서 모든 repository를 갖고 있는 Repositories structure를 정의하였다.<br>
또한 Repositories는 db instance를 갖고 있어서 user와 food repository의 생성자로 주입된다.</p>
<h2 id="application-layer">Application Layer<a hidden class="anchor" aria-hidden="true" href="#application-layer">#</a></h2>
<p>application은 domain과 interface에 연결한다.<br>
user application을 살펴보자</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">application</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;food-app/domain/entity&#34;</span>
	<span class="s">&#34;food-app/domain/repository&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">userApp</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">us</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">UserRepository</span>
<span class="p">}</span>

<span class="c1">//UserApp implements the UserAppInterface
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">_</span> <span class="nx">UserAppInterface</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">userApp</span><span class="p">{}</span>

<span class="kd">type</span> <span class="nx">UserAppInterface</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">SaveUser</span><span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
	<span class="nf">GetUsers</span><span class="p">()</span> <span class="p">([]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">GetUser</span><span class="p">(</span><span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nf">GetUserByEmailAndPassword</span><span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">userApp</span><span class="p">)</span> <span class="nf">SaveUser</span><span class="p">(</span><span class="nx">user</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">u</span><span class="p">.</span><span class="nx">us</span><span class="p">.</span><span class="nf">SaveUser</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">userApp</span><span class="p">)</span> <span class="nf">GetUser</span><span class="p">(</span><span class="nx">userId</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">u</span><span class="p">.</span><span class="nx">us</span><span class="p">.</span><span class="nf">GetUser</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">userApp</span><span class="p">)</span> <span class="nf">GetUsers</span><span class="p">()</span> <span class="p">([]</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">u</span><span class="p">.</span><span class="nx">us</span><span class="p">.</span><span class="nf">GetUsers</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">userApp</span><span class="p">)</span> <span class="nf">GetUserByEmailAndPassword</span><span class="p">(</span><span class="nx">user</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">u</span><span class="p">.</span><span class="nx">us</span><span class="p">.</span><span class="nf">GetUserByEmailAndPassword</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>UserApp은 UserRepository를 갖고있어 repository의 method를 호출할 수 있게 해준다.</p>
<h2 id="interface-layer">Interface Layer<a hidden class="anchor" aria-hidden="true" href="#interface-layer">#</a></h2>
<p>interface는 HTTP request와 response를 담당한다.<br>
여기서 인증, 유저관련, 음식관련 request를 받아들인다.</p>
<p><img loading="lazy" src="../../../img/server/food_app_interface_layer.png" alt="food_app_interface_layer.png"  />
</p>
<h3 id="user-handler">User Handler<a hidden class="anchor" aria-hidden="true" href="#user-handler">#</a></h3>
<p>save, get 등의 user 관련 method가 정의되어 있음.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">interfaces</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;food-app/application&#34;</span>
	<span class="s">&#34;food-app/domain/entity&#34;</span>
	<span class="s">&#34;food-app/infrastructure/auth&#34;</span>
	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;strconv&#34;</span>
<span class="p">)</span>

<span class="c1">//Users struct defines the dependencies that will be used
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Users</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">us</span> <span class="nx">application</span><span class="p">.</span><span class="nx">UserAppInterface</span>
	<span class="nx">rd</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">AuthInterface</span>
	<span class="nx">tk</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">TokenInterface</span>
<span class="p">}</span>

<span class="c1">//Users constructor
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewUsers</span><span class="p">(</span><span class="nx">us</span> <span class="nx">application</span><span class="p">.</span><span class="nx">UserAppInterface</span><span class="p">,</span> <span class="nx">rd</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">AuthInterface</span><span class="p">,</span> <span class="nx">tk</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">TokenInterface</span><span class="p">)</span> <span class="o">*</span><span class="nx">Users</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Users</span><span class="p">{</span>
		<span class="nx">us</span><span class="p">:</span> <span class="nx">us</span><span class="p">,</span>
		<span class="nx">rd</span><span class="p">:</span> <span class="nx">rd</span><span class="p">,</span>
		<span class="nx">tk</span><span class="p">:</span> <span class="nx">tk</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Users</span><span class="p">)</span> <span class="nf">SaveUser</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">user</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">User</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ShouldBindJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnprocessableEntity</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
			<span class="s">&#34;invalid_json&#34;</span><span class="p">:</span> <span class="s">&#34;invalid json&#34;</span><span class="p">,</span>
		<span class="p">})</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="c1">//validate the request:
</span><span class="c1"></span>	<span class="nx">validateErr</span> <span class="o">:=</span> <span class="nx">user</span><span class="p">.</span><span class="nf">Validate</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">validateErr</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnprocessableEntity</span><span class="p">,</span> <span class="nx">validateErr</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">newUser</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">us</span><span class="p">.</span><span class="nf">SaveUser</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusCreated</span><span class="p">,</span> <span class="nx">newUser</span><span class="p">.</span><span class="nf">PublicUser</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Users</span><span class="p">)</span> <span class="nf">GetUsers</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">users</span> <span class="o">:=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">Users</span><span class="p">{}</span> <span class="c1">//customize user
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="c1">//us, err = application.UserApp.GetUsers()
</span><span class="c1"></span>	<span class="nx">users</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">us</span><span class="p">.</span><span class="nf">GetUsers</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">users</span><span class="p">.</span><span class="nf">PublicUsers</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Users</span><span class="p">)</span> <span class="nf">GetUser</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">userId</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseUint</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">Param</span><span class="p">(</span><span class="s">&#34;user_id&#34;</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">user</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">us</span><span class="p">.</span><span class="nf">GetUser</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nf">PublicUser</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div><h3 id="authentication-handler">Authentication Handler<a hidden class="anchor" aria-hidden="true" href="#authentication-handler">#</a></h3>
<p>login_handler 는 로그인, 로그아웃, 리프레시 토큰 등의 method를 담당.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">interfaces</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;food-app/application&#34;</span>
	<span class="s">&#34;food-app/domain/entity&#34;</span>
	<span class="s">&#34;food-app/infrastructure/auth&#34;</span>
	<span class="s">&#34;github.com/dgrijalva/jwt-go&#34;</span>
	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;os&#34;</span>
	<span class="s">&#34;strconv&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Authenticate</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">us</span> <span class="nx">application</span><span class="p">.</span><span class="nx">UserAppInterface</span>
	<span class="nx">rd</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">AuthInterface</span>
	<span class="nx">tk</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">TokenInterface</span>
<span class="p">}</span>

<span class="c1">//Authenticate constructor
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewAuthenticate</span><span class="p">(</span><span class="nx">uApp</span> <span class="nx">application</span><span class="p">.</span><span class="nx">UserAppInterface</span><span class="p">,</span> <span class="nx">rd</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">AuthInterface</span><span class="p">,</span> <span class="nx">tk</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">TokenInterface</span><span class="p">)</span> <span class="o">*</span><span class="nx">Authenticate</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Authenticate</span><span class="p">{</span>
		<span class="nx">us</span><span class="p">:</span> <span class="nx">uApp</span><span class="p">,</span>
		<span class="nx">rd</span><span class="p">:</span> <span class="nx">rd</span><span class="p">,</span>
		<span class="nx">tk</span><span class="p">:</span> <span class="nx">tk</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">au</span> <span class="o">*</span><span class="nx">Authenticate</span><span class="p">)</span> <span class="nf">Login</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">user</span> <span class="o">*</span><span class="nx">entity</span><span class="p">.</span><span class="nx">User</span>
	<span class="kd">var</span> <span class="nx">tokenErr</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{}</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ShouldBindJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnprocessableEntity</span><span class="p">,</span> <span class="s">&#34;Invalid json provided&#34;</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="c1">//validate request:
</span><span class="c1"></span>	<span class="nx">validateUser</span> <span class="o">:=</span> <span class="nx">user</span><span class="p">.</span><span class="nf">Validate</span><span class="p">(</span><span class="s">&#34;login&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">validateUser</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnprocessableEntity</span><span class="p">,</span> <span class="nx">validateUser</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">u</span><span class="p">,</span> <span class="nx">userErr</span> <span class="o">:=</span> <span class="nx">au</span><span class="p">.</span><span class="nx">us</span><span class="p">.</span><span class="nf">GetUserByEmailAndPassword</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">userErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">userErr</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">ts</span><span class="p">,</span> <span class="nx">tErr</span> <span class="o">:=</span> <span class="nx">au</span><span class="p">.</span><span class="nx">tk</span><span class="p">.</span><span class="nf">CreateToken</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">tErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">tokenErr</span><span class="p">[</span><span class="s">&#34;token_error&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">tErr</span><span class="p">.</span><span class="nf">Error</span><span class="p">()</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnprocessableEntity</span><span class="p">,</span> <span class="nx">tErr</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">saveErr</span> <span class="o">:=</span> <span class="nx">au</span><span class="p">.</span><span class="nx">rd</span><span class="p">.</span><span class="nf">CreateAuth</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">ts</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">saveErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">saveErr</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">userData</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
	<span class="nx">userData</span><span class="p">[</span><span class="s">&#34;access_token&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">AccessToken</span>
	<span class="nx">userData</span><span class="p">[</span><span class="s">&#34;refresh_token&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">RefreshToken</span>
	<span class="nx">userData</span><span class="p">[</span><span class="s">&#34;id&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">ID</span>
	<span class="nx">userData</span><span class="p">[</span><span class="s">&#34;first_name&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">FirstName</span>
	<span class="nx">userData</span><span class="p">[</span><span class="s">&#34;last_name&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">LastName</span>

	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">userData</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">au</span> <span class="o">*</span><span class="nx">Authenticate</span><span class="p">)</span> <span class="nf">Logout</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">//check is the user is authenticated first
</span><span class="c1"></span>	<span class="nx">metadata</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">au</span><span class="p">.</span><span class="nx">tk</span><span class="p">.</span><span class="nf">ExtractTokenMetadata</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span> <span class="s">&#34;Unauthorized&#34;</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="c1">//if the access token exist and it is still valid, then delete both the access token and the refresh token
</span><span class="c1"></span>	<span class="nx">deleteErr</span> <span class="o">:=</span> <span class="nx">au</span><span class="p">.</span><span class="nx">rd</span><span class="p">.</span><span class="nf">DeleteTokens</span><span class="p">(</span><span class="nx">metadata</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">deleteErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span> <span class="nx">deleteErr</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="s">&#34;Successfully logged out&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">//Refresh is the function that uses the refresh_token to generate new pairs of refresh and access tokens.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">au</span> <span class="o">*</span><span class="nx">Authenticate</span><span class="p">)</span> <span class="nf">Refresh</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">mapToken</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ShouldBindJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mapToken</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnprocessableEntity</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">refreshToken</span> <span class="o">:=</span> <span class="nx">mapToken</span><span class="p">[</span><span class="s">&#34;refresh_token&#34;</span><span class="p">]</span>

	<span class="c1">//verify the token
</span><span class="c1"></span>	<span class="nx">token</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">refreshToken</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">token</span> <span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Token</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">//Make sure that the token method conform to &#34;SigningMethodHMAC&#34;
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">Method</span><span class="p">.(</span><span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">SigningMethodHMAC</span><span class="p">);</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unexpected signing method: %v&#34;</span><span class="p">,</span> <span class="nx">token</span><span class="p">.</span><span class="nx">Header</span><span class="p">[</span><span class="s">&#34;alg&#34;</span><span class="p">])</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;REFRESH_SECRET&#34;</span><span class="p">)),</span> <span class="kc">nil</span>
	<span class="p">})</span>
	<span class="c1">//any error may be due to token expiration
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="c1">//is token valid?
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">Claims</span><span class="p">.(</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Claims</span><span class="p">);</span> <span class="p">!</span><span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">token</span><span class="p">.</span><span class="nx">Valid</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="c1">//Since token is valid, get the uuid:
</span><span class="c1"></span>	<span class="nx">claims</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">Claims</span><span class="p">.(</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">MapClaims</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span><span class="p">.</span><span class="nx">Valid</span> <span class="p">{</span>
		<span class="nx">refreshUuid</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">claims</span><span class="p">[</span><span class="s">&#34;refresh_uuid&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span> <span class="c1">//convert the interface to string
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnprocessableEntity</span><span class="p">,</span> <span class="s">&#34;Cannot get uuid&#34;</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">userId</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseUint</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%.f&#34;</span><span class="p">,</span> <span class="nx">claims</span><span class="p">[</span><span class="s">&#34;user_id&#34;</span><span class="p">]),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnprocessableEntity</span><span class="p">,</span> <span class="s">&#34;Error occurred&#34;</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="c1">//Delete the previous Refresh Token
</span><span class="c1"></span>		<span class="nx">delErr</span> <span class="o">:=</span> <span class="nx">au</span><span class="p">.</span><span class="nx">rd</span><span class="p">.</span><span class="nf">DeleteRefresh</span><span class="p">(</span><span class="nx">refreshUuid</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">delErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">//if any goes wrong
</span><span class="c1"></span>			<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span> <span class="s">&#34;unauthorized&#34;</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="c1">//Create new pairs of refresh and access tokens
</span><span class="c1"></span>		<span class="nx">ts</span><span class="p">,</span> <span class="nx">createErr</span> <span class="o">:=</span> <span class="nx">au</span><span class="p">.</span><span class="nx">tk</span><span class="p">.</span><span class="nf">CreateToken</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">createErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusForbidden</span><span class="p">,</span> <span class="nx">createErr</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="c1">//save the tokens metadata to redis
</span><span class="c1"></span>		<span class="nx">saveErr</span> <span class="o">:=</span> <span class="nx">au</span><span class="p">.</span><span class="nx">rd</span><span class="p">.</span><span class="nf">CreateAuth</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">ts</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">saveErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusForbidden</span><span class="p">,</span> <span class="nx">saveErr</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">tokens</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
			<span class="s">&#34;access_token&#34;</span><span class="p">:</span>  <span class="nx">ts</span><span class="p">.</span><span class="nx">AccessToken</span><span class="p">,</span>
			<span class="s">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">RefreshToken</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusCreated</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span> <span class="s">&#34;refresh token expired&#34;</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="running-the-application">Running the Application<a hidden class="anchor" aria-hidden="true" href="#running-the-application">#</a></h2>
<p>main.go 에서는 route 정의, db에 연결, 애플리케이션 시작 등의 기능을 하고 있다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;food-app/infrastructure/auth&#34;</span>
	<span class="s">&#34;food-app/infrastructure/persistence&#34;</span>
	<span class="s">&#34;food-app/interfaces&#34;</span>
	<span class="s">&#34;food-app/interfaces/fileupload&#34;</span>
	<span class="s">&#34;food-app/interfaces/middleware&#34;</span>
	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
	<span class="s">&#34;github.com/joho/godotenv&#34;</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;os&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">//To load our environmental variables.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">godotenv</span><span class="p">.</span><span class="nf">Load</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;no env gotten&#34;</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="nx">dbdriver</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DB_DRIVER&#34;</span><span class="p">)</span>
	<span class="nx">host</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DB_HOST&#34;</span><span class="p">)</span>
	<span class="nx">password</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DB_PASSWORD&#34;</span><span class="p">)</span>
	<span class="nx">user</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DB_USER&#34;</span><span class="p">)</span>
	<span class="nx">dbname</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DB_NAME&#34;</span><span class="p">)</span>
	<span class="nx">port</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DB_PORT&#34;</span><span class="p">)</span>

	<span class="c1">//redis details
</span><span class="c1"></span>	<span class="nx">redis_host</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;REDIS_HOST&#34;</span><span class="p">)</span>
	<span class="nx">redis_port</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;REDIS_PORT&#34;</span><span class="p">)</span>
	<span class="nx">redis_password</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;REDIS_PASSWORD&#34;</span><span class="p">)</span>


	<span class="nx">services</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">persistence</span><span class="p">.</span><span class="nf">NewRepositories</span><span class="p">(</span><span class="nx">dbdriver</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">dbname</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">services</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="nx">services</span><span class="p">.</span><span class="nf">Automigrate</span><span class="p">()</span>

	<span class="nx">redisService</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">auth</span><span class="p">.</span><span class="nf">NewRedisDB</span><span class="p">(</span><span class="nx">redis_host</span><span class="p">,</span> <span class="nx">redis_port</span><span class="p">,</span> <span class="nx">redis_password</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">tk</span> <span class="o">:=</span> <span class="nx">auth</span><span class="p">.</span><span class="nf">NewToken</span><span class="p">()</span>
	<span class="nx">fd</span> <span class="o">:=</span> <span class="nx">fileupload</span><span class="p">.</span><span class="nf">NewFileUpload</span><span class="p">()</span>

	<span class="nx">users</span> <span class="o">:=</span> <span class="nx">interfaces</span><span class="p">.</span><span class="nf">NewUsers</span><span class="p">(</span><span class="nx">services</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="nx">redisService</span><span class="p">.</span><span class="nx">Auth</span><span class="p">,</span> <span class="nx">tk</span><span class="p">)</span>
	<span class="nx">foods</span> <span class="o">:=</span> <span class="nx">interfaces</span><span class="p">.</span><span class="nf">NewFood</span><span class="p">(</span><span class="nx">services</span><span class="p">.</span><span class="nx">Food</span><span class="p">,</span> <span class="nx">services</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="nx">fd</span><span class="p">,</span> <span class="nx">redisService</span><span class="p">.</span><span class="nx">Auth</span><span class="p">,</span> <span class="nx">tk</span><span class="p">)</span>
	<span class="nx">authenticate</span> <span class="o">:=</span> <span class="nx">interfaces</span><span class="p">.</span><span class="nf">NewAuthenticate</span><span class="p">(</span><span class="nx">services</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="nx">redisService</span><span class="p">.</span><span class="nx">Auth</span><span class="p">,</span> <span class="nx">tk</span><span class="p">)</span>

	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">middleware</span><span class="p">.</span><span class="nf">CORSMiddleware</span><span class="p">())</span> <span class="c1">//For CORS
</span><span class="c1"></span>
	<span class="c1">//user routes
</span><span class="c1"></span>	<span class="nx">r</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/users&#34;</span><span class="p">,</span> <span class="nx">users</span><span class="p">.</span><span class="nx">SaveUser</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/users&#34;</span><span class="p">,</span> <span class="nx">users</span><span class="p">.</span><span class="nx">GetUsers</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/users/:user_id&#34;</span><span class="p">,</span> <span class="nx">users</span><span class="p">.</span><span class="nx">GetUser</span><span class="p">)</span>

	<span class="c1">//post routes
</span><span class="c1"></span>	<span class="nx">r</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/food&#34;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nf">AuthMiddleware</span><span class="p">(),</span> <span class="nx">middleware</span><span class="p">.</span><span class="nf">MaxSizeAllowed</span><span class="p">(</span><span class="mi">8192000</span><span class="p">),</span> <span class="nx">foods</span><span class="p">.</span><span class="nx">SaveFood</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">PUT</span><span class="p">(</span><span class="s">&#34;/food/:food_id&#34;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nf">AuthMiddleware</span><span class="p">(),</span> <span class="nx">middleware</span><span class="p">.</span><span class="nf">MaxSizeAllowed</span><span class="p">(</span><span class="mi">8192000</span><span class="p">),</span> <span class="nx">foods</span><span class="p">.</span><span class="nx">UpdateFood</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/food/:food_id&#34;</span><span class="p">,</span> <span class="nx">foods</span><span class="p">.</span><span class="nx">GetFoodAndCreator</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">DELETE</span><span class="p">(</span><span class="s">&#34;/food/:food_id&#34;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nf">AuthMiddleware</span><span class="p">(),</span> <span class="nx">foods</span><span class="p">.</span><span class="nx">DeleteFood</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/food&#34;</span><span class="p">,</span> <span class="nx">foods</span><span class="p">.</span><span class="nx">GetAllFood</span><span class="p">)</span>

	<span class="c1">//authentication routes
</span><span class="c1"></span>	<span class="nx">r</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/login&#34;</span><span class="p">,</span> <span class="nx">authenticate</span><span class="p">.</span><span class="nx">Login</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/logout&#34;</span><span class="p">,</span> <span class="nx">authenticate</span><span class="p">.</span><span class="nx">Logout</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/refresh&#34;</span><span class="p">,</span> <span class="nx">authenticate</span><span class="p">.</span><span class="nx">Refresh</span><span class="p">)</span>


	<span class="c1">//Starting the application
</span><span class="c1"></span>	<span class="nx">app_port</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;PORT&#34;</span><span class="p">)</span> <span class="c1">//using heroku host
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">app_port</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">app_port</span> <span class="p">=</span> <span class="s">&#34;8888&#34;</span> <span class="c1">//localhost
</span><span class="c1"></span>	<span class="p">}</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="o">+</span><span class="nx">app_port</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div><h2 id="middleware">Middleware<a hidden class="anchor" aria-hidden="true" href="#middleware">#</a></h2>
<p>위 main.go 파일에서 특정 route는 제한되어 있다. AuthMiddleware는 인증되지 않은 유저의 접근을 제한할 것이다.<br>
CORSMiddleware는 다른 domain으로의 data 전송을 허용해준다.
MaxSizeAllowed는 미들웨어에서 제한된 사이즈 이상의 파일의 업로드를 막아준다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">middleware</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;bytes&#34;</span>
	<span class="s">&#34;food-app/infrastructure/auth&#34;</span>
	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
	<span class="s">&#34;io/ioutil&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">AuthMiddleware</span><span class="p">()</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">auth</span><span class="p">.</span><span class="nf">TokenValid</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
				<span class="s">&#34;status&#34;</span><span class="p">:</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span>
				<span class="s">&#34;error&#34;</span><span class="p">:</span>  <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span>
			<span class="p">})</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">Abort</span><span class="p">()</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">CORSMiddleware</span><span class="p">()</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Access-Control-Allow-Origin&#34;</span><span class="p">,</span> <span class="s">&#34;*&#34;</span><span class="p">)</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Access-Control-Allow-Credentials&#34;</span><span class="p">,</span> <span class="s">&#34;true&#34;</span><span class="p">)</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Access-Control-Allow-Headers&#34;</span><span class="p">,</span> <span class="s">&#34;Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token, Authorization, accept, origin, Cache-Control, X-Requested-With&#34;</span><span class="p">)</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Access-Control-Allow-Methods&#34;</span><span class="p">,</span> <span class="s">&#34;POST, OPTIONS, GET, PUT, PATCH, DELETE&#34;</span><span class="p">)</span>

		<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span> <span class="o">==</span> <span class="s">&#34;OPTIONS&#34;</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">AbortWithStatus</span><span class="p">(</span><span class="mi">204</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">//Avoid a large file from loading into memory
</span><span class="c1">//If the file size is greater than 8MB dont allow it to even load into memory and waste our time.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">MaxSizeAllowed</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int64</span><span class="p">)</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">MaxBytesReader</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
		<span class="nx">buff</span><span class="p">,</span> <span class="nx">errRead</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetRawData</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">errRead</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="c1">//c.JSON(http.StatusRequestEntityTooLarge,&#34;too large&#34;)
</span><span class="c1"></span>			<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusRequestEntityTooLarge</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
				<span class="s">&#34;status&#34;</span><span class="p">:</span>     <span class="nx">http</span><span class="p">.</span><span class="nx">StatusRequestEntityTooLarge</span><span class="p">,</span>
				<span class="s">&#34;upload_err&#34;</span><span class="p">:</span> <span class="s">&#34;too large: upload an image less than 8MB&#34;</span><span class="p">,</span>
			<span class="p">})</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">Abort</span><span class="p">()</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">buf</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">buff</span><span class="p">)</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">NopCloser</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://icecat471.github.io/devlog/tags/go/">go</a></li>
      <li><a href="https://icecat471.github.io/devlog/tags/golang/">golang</a></li>
      <li><a href="https://icecat471.github.io/devlog/tags/ddd/">DDD</a></li>
      <li><a href="https://icecat471.github.io/devlog/tags/domain-driven-design/">Domain-Driven Design</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://icecat471.github.io/devlog/post/database/mariadb_foreign_key/">
    <span class="title">Next Page »</span>
    <br>
    <span>[MariaDB] 외래키 제약조건</span>
  </a>
</nav>

  </footer><script src="https://utteranc.es/client.js"
        repo="icecat471/devlog"
        issue-term="pathname"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="https://icecat471.github.io/devlog/">icecat471&#39;s Devlog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
